<?php
/***************************************************************************
 *   Copyright (C) by Stepanov Evgeny                                      *
 *   from.stev@gmail.com                                                   *
 ***************************************************************************
 * $Id: ticketsTable.tpl.html 1775 2011-05-25 12:19:01Z stev $ */

/*
 * должны прийти:
 * - $_objects	(массив объектов)
 * - $_filter	(фильтр)
 * - $_name		(название таблицы)
 * - $_actions	(действия)
 */

$maxSizeTextForCut = 35;

if (empty($_objects))
	throw new Exception("array 'objects' is empty");

$sortUrl = Href::create('pageWorkList', 'sort');

$object = current($_objects);
$fields = $object->proto()->getPropertyList();


if ($_filter instanceof IFieldsFilter) {
	$fields	= $_filter->setAllFields($fields)->
		getList();
}

if (!$_widgetName)
	$_widgetName = strtolower($object->dao()->getObjectName());


?>

<style>
/*.plain tr.alt td {
    background: inherit;
}*/
.plain tr.over td {
    background: #ebf3fd;
}
</style>

	<table id="table_<?=$_widgetName?>" cellpadding="4" class="plain">
		<tr>
<?
foreach ($fields as $key => $type) { ?>
			<td class="headGray">
				<b><?

	//	сука хардкод и кописаст
	// см. pageWorkList.class
	if ($_sortField = $key) {
		switch ($_sortMode) {
			case 'asc':
				$sortUrl->
					set('sortMode', 'desc');
				break;
			case 'desc':
				$sortUrl->
					set('sortMode', 'asc');
				break;
			default :
				$sortUrl->
					set('sortMode', 'desc');
		}
	}

	$sortUrl->set('sortField', $key);
?>
				<a href="<?=$sortUrl?>"><?=_($key) ?></a>
				</b>
			</td>
<?}

if (count($_actions)) { ?>
			<td class="headGray" colspan="<?=count($_actions) ?>">
				<b><?=_('действие')?></b>
			</td>
<?}?>


		</tr>
<?
foreach ($_objects as $key => $object) { ?>
		<tr id="tr_<?=$object->getId()?>" >
<?
	foreach ($fields as $fieldName => $type) {
		$method = 'get'.ucfirst($fieldName);
		$text = method_exists($object, $method)
			? GuiUtils::ObjectToString($object->{$method}())
			: '&nbsp;';

		$css = null;
		$cssArray = array(
			0 => 'warning',
			'Good' => 'good',
			'Bad' => 'error',
			'Test' => 'info',
		);

//		сука хардкод и кописаст
//		билять, это все по другому надо делать, но сейчас так
		switch($fieldName) {
			case 'design':	$css = $text= ($text) ? $cssArray['Good'] : $cssArray[0];
				break;
			case 'layout':	$css = $text = ($text) ? $cssArray['Good'] : $cssArray[0];
				break;
			case 'testWorkOld':
			case 'testWork':
			case 'testDesign':
			case 'testText':
					$css = $text = (isset($cssArray[$text])) ? $cssArray[$text] : null;
				break;

			case 'r4':
				$text = TrackUtils::parseTicketUrl($text, 'http://bigwig.rdw.ru:5555/rabota/ticket');
				break;
			case 'r5':
				$text = TrackUtils::parseTicketUrl($text, 'http://bigwig.rdw.ru:5555/rabota5/ticket');
				break;

			case 'urldmz':
				$text = preg_replace('~(^|\s)(.*?)(\s)~', '<p>$2</p>$3', $text);

			default:
				if (mb_strlen($text) > $maxSizeTextForCut) {
					$uid = $object->getId().'_'.$fieldName;

					$smallText = TextUtils::cutOnSpace($text, $maxSizeTextForCut, '...');

					$text = <<<OUT
				<div class="js_popup" rel="#$uid" >$smallText
					<div id="$uid" class="overlay">$text</div>
				</div>
OUT;
				}
				break;
		}
?>
			<td class="<?= $css ? $css: 'span' ?>">
				<?= $text; ?>
			</td>
<?	}

	foreach ($_actions as $actionName => $url) { ?>
			<td class="span">
				<a href="<?=$url->set('id', $object->getId()) ?>"><?=_($actionName)?></a>
			</td>
<?	}?>
		</tr><?
}
?>
	</table>

<script>
// типа подсветка строк таблицы
//$(document).ready(function(){
//	$("tr").mouseover(function() {
//		var my;
//			my = $(this).attr("class");
//
//		console.log(my);
//		$(this).addClass('over');
//
//		$(this).attr('class', my);
//
////		$(this).toggleClass("over");
//	});
//});
</script>